<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Gatto Alessandro">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elux RoadMap</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link href="interface_style.css" rel="stylesheet" type="text/css">
</head>

<header>
    <nav class=" p-2 pb-3 ps-4 text-white fixed-top " id="navbar">
        <div class="container-fluid">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="login.html" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                    <img src="Trenitalia_Logo_White.png" alt="" width="300" height="auto" class="d-inline-block align-text-top">&nbsp; &nbsp; &nbsp; &nbsp; Train Sensors Platform
                </a>

                <ul class="ps-4 nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                    <li><a href="login.html" class="pe-2 nav-link px-2 text-secondary">Login Page</a></li>
                    <li><a href="interface.html" id="linkSur" class="pe-2 nav-link px-2 text-white">Interface</a></li>
                    <li><a href="options.html" id="linkRec" class="nav-link px-2 text-white">Options</a></li>
                </ul>

            </div>
        </div>
        </div>
    </nav>
</header>

<body>

    <div class="w-100 h-100 mt-5" id="parent">
    </div>
    <script>
        // Getting the values from the login page 
        //const enabledPage = localStorage.getItem('enabledPage');
        //const auth = localStorage.getItem('auth');
        //const trainIdString = localStorage.getItem('trainIdString');


        const auth = 1;
        const enabledPage = 1;
        const trainIdString = "IT12345,IT23456";
        const trainNamesArray = trainIdString.split(',');

        console.log("Is the page enabled? " + enabledPage);

        // This is to check if you already logged in, else it will deactivate the page and links
        function CheckAuth() {
            var linkSur = document.getElementById('linkSur')
            if (auth == 1) {
                linkSur.href = "interface.html";
                $("#bigWrapper").show();
                $("#steps").show();

            } else {
                const button1 = document.getElementById('nextBtn');
                const button2 = document.getElementById('prevBtn');
                button1.disabled = true;
                button2.disabled = true;
                alert("go back to the Login page");
            }
        }

        var serverPort;
        var serverHost;
        // Getting the values from the config file 
        function loadConfig() {
            $.getJSON('config.json', function(data) {
                serverPort = data.serverPort;
                serverHost = data.serverHost;
                console.log("Config loaded")

                getGraphCtrlInfo();
            });
        }
        loadConfig();

        // Initializing var used inside the various get
        var array1 = {};
        var array2 = {};
        var array3 = {};
        var array4 = {};

        var facNames = [];
        var MedieOld = [];
        var MedieNew = [];
        var marksCanvas = [];
        var arrayCat = ["1", "2", "3", "4", "5", "6"];
        var dynamicalCanvas = [];
        var dynamicalTrainDiv = [];
        var dynamicalButtonSur = [];
        var dynamicalButtonRec = [];
        var dynamicalFacName = [];
        var dynamicalName = [];
        var marksData = [];
        var radarChart = [];
        var rowDiv = [];
        var usersIdArray = [];
        var facIdArray = [];




        function createVariables() {
            let rowNum = 0;
             var dynamicalTrainImg = document.createElement('img');
             dynamicalTrainImg.setAttribute('src', "trainHead.png");
             dynamicalTrainImg.setAttribute('width', "30%");
             dynamicalTrainImg.setAttribute('height', "15%");

            for (var i = 0; i < 6; ++i) {
                if (i % 4 == 0) {
                    rowNum = i / 4;
                    rowDiv[rowNum] = document.createElement('div');
                    rowDiv[rowNum].setAttribute('class', "row border");
                }
                let canvasName = "marksChart" + i;
                let divFacName = "titleDiv" + i;
                let FacName = "factoryName" + i;
                let divTrainName = "TrainDiv" + i;
                let divTrainId = "TrainId" + i;
                let btnFront = "btnfront" + i;
                let btnBack = "btnback" + i;
                let btnTemp = "btntemp" + i;
                let btnMsg = "btnmsg" + i;
                let btnEmergency = "btnemergency" + i;

                let wagonDetails = "wagondetails"+i
                marksCanvas[i] = document.getElementById(canvasName);

                dynamicalTrainDiv[i] = document.createElement('div');
                dynamicalTrainDiv[i].setAttribute('class', "col-md-6 col-xl-3 border-start");
                dynamicalTrainDiv[i].setAttribute('id', divTrainName);
                dynamicalTrainDiv[i].setAttribute('onclick', "ShowTrainWagonDiv(this.id);");

                dynamicalTrainId[i] = document.createElement('h4');
                dynamicalTrainId[i].setAttribute('class', "text-center");
                dynamicalTrainId[i].setAttribute('id', divTrainId);
                document.getElementById(divTrainId).textContent = trainNamesArray[i];

                
                dynamicalTrainWagonDiv[i] = document.createElement('div');
                dynamicalTrainWagonDiv[i].setAttribute('class', "col-md-6 col-xl-3 border-start");
                dynamicalTrainWagonDiv[i].setAttribute('id', divTrainName);
                dynamicalTrainWagonDiv[i].setAttribute('onclick', "ShowTrainWagonDiv(this.id);");

                dynamicalWagonName[i] = document.createElement('h6');
                dynamicalWagonName[i].setAttribute('class', "col-md-6 col-xl-3 border-start");
                dynamicalWagonName[i].setAttribute('id', "wagon" + i);
                document.getElementById("wagon" + i).textContent = "wagon" + i ;

                dynamicalWagonDetails[i] = document.createElement('p');
                dynamicalWagonDetails[i].setAttribute('id', "text-center");
                document.getElementById(btnSurName).textContent = array2[i];
                
                //DYNAMICAL ALARM


                dynamicalWagonFocus[i] = document.createElement('div');
                dynamicalWagonFocus[i].setAttribute('class', "col-md-6 col-xl-3 border-start");

                dynButtonFront_Door[i] = document.createElement('button');
                dynButtonFront_Door[i].setAttribute('type', "button");
                dynButtonFront_Door[i].setAttribute('id', btnFront);
                dynButtonFront_Door[i].setAttribute('onclick', "sendTelemetry(this.id)");
                document.getElementById(btnFront).textContent = "Toggle front door";

                dynButtonBack_Door[i] = document.createElement('button');
                dynButtonBack_Door[i].setAttribute('type', "button");
                dynButtonBack_Door[i].setAttribute('id', btnBack);
                dynButtonBack_Door[i].setAttribute('onclick', "sendTelemetry(this.id)");
                document.getElementById(btnBack).textContent = "Toggle back door";

                dynButtonSetTemp[i] = document.createElement('button');
                dynButtonSetTemp[i].setAttribute('type', "button");
                dynButtonSetTemp[i].setAttribute('id', btnTemp);
                dynButtonSetTemp[i].setAttribute('onclick', "sendTelemetry(this.id)");
                document.getElementById(btnTemp).textContent ="Set new temperature";

                dynButtonSendMsg[i] = document.createElement('button');
                dynButtonSendMsg[i].setAttribute('type', "button");
                dynButtonSendMsg[i].setAttribute('id', btnMsg);
                dynButtonSendMsg[i].setAttribute('onclick', "sendTelemetry(this.id)");
                document.getElementById(btnMsg).textContent = "Send message";

                dynButtonSendEmergency[i] = document.createElement('button');
                dynButtonSendEmergency[i].setAttribute('type', "button");
                dynButtonSendEmergency[i].setAttribute('id', btnEmergency);
                dynButtonSendEmergency[i].setAttribute('onclick', "sendEmergency(this.id)");
                document.getElementById(btnEmergency).textContent = "Send emergency message";


                // Append the newborn column div to the div row
                rowDiv[rowNum].appendChild(dynamicalTrainDiv[i]);

                dynamicalTrainDiv[i].appendChild(dynamicalTrainId[i]);

                dynamicalTrainWagonDiv[i].appendChild(dynamicalWagonName[i]);
                dynamicalTrainWagonDiv[i].appendChild(dynamicalWagonDetails[i]);

                dynamicalWagonFocus[i].appendChild(dynamicalWagonDetails[i]);
                dynamicalWagonFocus[i].appendChild(dynButtonFront_Door[i]);
                dynamicalWagonFocus[i].appendChild(dynButtonBack_Door[i]);
                dynamicalWagonFocus[i].appendChild(dynButtonSetTemp[i]);
                dynamicalWagonFocus[i].appendChild(dynButtonSendMsg[i]);
                dynamicalWagonFocus[i].appendChild(dynButtonSendEmergency[i]);

                // Append the new whole div as child to the parent tag
                document.getElementById("parent").appendChild(rowDiv[rowNum]);

            }
        }


        function redirect(btnId) {
            arrayIndex = btnId.replace('btnsur', '');
            console.log("arrayIndex " + arrayIndex)

            localStorage.clear();
            localStorage.setItem('disabledPage', enabledPage);
            localStorage.setItem('auth', auth);
        }

        function getTrainsData() {
            $.ajax({
                method: "GET",
                url: "http://" + serverHost + ":" + serverPort + "/trainData",
                data: {
                    trainIds: trainIdString,
                }
            }).done(function(res) {
                console.log("all three get request results");
                array1 = res.wagonNumber; // Returns the number of wagons per train
                console.log(array1);
                array2 = res.trains; // Returns the values of the telemetrics of the trains
                console.log(array2);
                array3 = res.alarms; // Returns the name of the grades (like digital factory,factory of the future...)
                console.log(array3);
                sortGetInfo(); // Setting up local variables with db values
            }).fail(function() {
                alert("Sorry. Server unavailable. ggraphctrlinfo");
            });
        }
        function postTelemetryAjax() {
            serializedDataFactGrade = createTelemetryObjToPost();
            // Fire off the request to update the factory data
            $.ajax({
                method: "POST",
                url: "http://" + serverHost + ":" + serverPort + "/telemetry", //URGENT NEED CHANGE THINGS, BECAUSE INSIDE THE FACTORY TABLE NOW GOES THE AVG OF THE USER'S FACTORY DATA
                data: {
                    telemetry: serializedDataFactGrade
                }
                // Callback handler that will be called on success
            }).done(function(res) {
                console.log(res);
                console.log(postSuccess);
                console.log("telemetry Post success");
                // Callback handler that will be called on failure
            }).catch(function(res, textStatus, errorThrown) {
                console.error("The following error occurred: " + textStatus, errorThrown);
            });
        }
    </script>
</body>

</html>